---
title: "Gaussian Model Trained with Unconstrained HMC"
author: "Sara Taheri and Robert Osazwa Ness"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r, warning=FALSE, message=FALSE, include=FALSE}
library(purrr)
library(rstan)
library(bayesplot)
library(ggplot2)
options(mc.cores = parallel::detectCores())
rstan_options(auto_write = TRUE)
```

```{r}
seed = 234
set.seed(seed)
L = 5
D = 1000
N = 8
```


Let's compile the model:

```{r, message=FALSE, warning=FALSE}
mod <- rstan::stan_model("model_str.stan")
```

We want to test the model using MLE 'optimizing', because it is faster than Bayesian inference:

```{r, message=FALSE, warning=FALSE}
data_list <- list(u=knocker::u_train, L=L, D=D, x = knocker::x_train, N =N, m = knocker::m_train, y = knocker::y_train, m_and_u = cbind(knocker::m_train,knocker::u_train))
optim_fit <- optimizing(mod, data=data_list)
```

Let's compare the estimates of parameters with their actual values:

```{r}
optim_fit$par[1:5] #estimated mu
knocker::mu #real mu
optim_fit$par[6:45] #estimated alpha
knocker::alpha #real alpha
optim_fit$par[46:53] #estimated beta
knocker::beta #real beta
optim_fit$par[54:59] #estimated gamma
knocker::gamma #real gamma
```

It seems like the parameters are closely estimated except for $\mu$. Now we will proceed with HMC inference. This is the result of HMC run with 2000 iteration, 1000 warmup, 2 chains, and a fixed seed. 

```{r fig.height=8, fig.width=8}
stan_trace(pars = "mu", knocker::hmc_fit)
```

```{r fig.height=8, fig.width=8}
stan_trace(pars = "alpha", knocker::hmc_fit)
```

```{r fig.height=8, fig.width=8}
stan_trace(pars = "beta", knocker::hmc_fit)
```

```{r fig.height=8, fig.width=8}
stan_trace(pars = "gamma", knocker::hmc_fit)
```

Now let's extract the samples:

```{r}
samples_mu <- extract(knocker::hmc_fit, "mu")
class(samples_mu)
colnames(samples_mu$mu) <- paste0("mu_", 1:L)
summary(samples_mu$mu)
knocker::mu
```

```{r}
# samples_alpha <- extract(knocker::hmc_fit, "alpha")
# summary(samples_alpha$alpha)
# knocker::alpha
```

```{r}
#samples_beta <- extract(knocker::hmc_fit, "beta")
# colnames(samples_beta$beta) <- paste0("beta_", 1:N)
#summary(samples_beta$beta)
#knocker::beta
```

```{r}
#samples_gamma <- extract(knocker::hmc_fit, "gamma")
#colnames(samples_gamma$gamma) <- paste0("gamma_", 1:(L+1))
#summary(samples_gamma$gamma)
#knocker::gamma
```

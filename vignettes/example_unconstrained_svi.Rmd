---
title: "Gaussian Model Trained with Unconstrained SVI"
author: "Sara Taheri and Robert Osazwa Ness"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r, warning=FALSE, message=FALSE, include=FALSE}
library(purrr)
library(rstan)
library(bayesplot)
library(ggplot2)
library(usethis)
options(mc.cores = parallel::detectCores())
rstan_options(auto_write = TRUE)
```

```{r}
seed = 234
set.seed(seed)
L = 5
D = 1000
N = 8
```

Let's compile the model:

```{r, message=FALSE, warning=FALSE}
mod <- rstan::stan_model("model_str.stan")
```

Let's use the SVI algorithm (rstan::vb()) to learn the parameters. The result of running the SVI algorithm is stored as vb_fit.rda in data folder.
```{r}
summary(knocker::vb_fit)$summary[, "mean"][1:L]
knocker::mu

summary(knocker::vb_fit)$summary[, "mean"][(L+1):(L+(L*N))]
knocker::alpha

summary(knocker::vb_fit)$summary[, "mean"][(L+(L*N)+1):(L+(L*N)+N)]
knocker::beta

summary(knocker::vb_fit)$summary[, "mean"][(L+(L*N)+N+1):(L+(L*N)+N+L+1)]
knocker::gamma
```

Doesn't predict gamma well.

# Estimating the parameters in presence of hidden confounder U

```{r, message=FALSE, warning=FALSE}
mod_with_hidden_confounder <- rstan::stan_model("model_str_with_latent_confounder.stan")
```

```{r}
data_list_with_hidden_confounder <- list(L=L, D=D, x = knocker::x_train, N =N, y = knocker::y_train, m = knocker::m_train)
```

```{r}
optim_fit_with_hidden_confounder <- optimizing(mod_with_hidden_confounder, data=data_list_with_hidden_confounder)
```


```{r}
optim_fit_with_hidden_confounder$par[1:5] #estimated mu
knocker::mu #real mu
optim_fit_with_hidden_confounder$par[5006:5045] #estimated alpha
knocker::alpha #real alpha
optim_fit_with_hidden_confounder$par[5046:5053] #estimated beta
knocker::beta #real beta
optim_fit_with_hidden_confounder$par[5054:5059] #estimated gamma
knocker::gamma #real gamma
```
